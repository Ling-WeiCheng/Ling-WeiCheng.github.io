<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="styles.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.4.0/fonts/remixicon.css" rel="stylesheet">
    <title>AI体质解析 - 云苓智体</title>
    <style>
        .chat__container {
            max-width: 800px;
            margin: 0 auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .chat__messages {
            height: 500px;
            overflow-y: auto;
            padding: 20px;
        }

        .chat__message {
            margin-bottom: 15px;
            padding: 12px 16px;
            border-radius: 8px;
            max-width: 80%;
            line-height: 1.5;
        }

        .chat__message--user {
            background: var(--primary-color);
            color: white;
            margin-left: auto;
        }

        .chat__message--ai {
            background: var(--primary-color-light);
            color: var(--text-dark);
        }

        .chat__input-area {
            display: flex;
            padding: 15px;
            background: #f8f9fa;
            border-top: 1px solid #eee;
        }

        .chat__input-area input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            font-size: 14px;
        }

        .chat__input-area button {
            padding: 10px 20px;
        }

        .payment-prompt {
            margin: 1rem 0;
            padding: 1rem;
            background: var(--primary-color-light);
            border-radius: 8px;
            text-align: center;
        }

        .payment-button {
            background: var(--secondary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 0.75rem 0;
            font-size: 1rem;
            transition: background-color 0.3s;
        }

        .payment-button:hover {
            background: #e67e22;
        }

        .payment-benefits {
            text-align: left;
            list-style: none;
            padding: 0.75rem 0;
            margin: 0;
        }

        .payment-benefits li {
            margin: 0.5rem 0;
            color: var(--text-dark);
            padding-left: 1.5rem;
            position: relative;
        }

        .payment-benefits li:before {
            content: "✓";
            color: var(--primary-color);
            position: absolute;
            left: 0;
        }

        .typing-indicator {
            font-style: italic;
            color: var(--text-light);
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            display: inline-block;
        }

        .typing-indicator::after {
            content: "...";
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0% { content: ""; }
            25% { content: "."; }
            50% { content: ".."; }
            75% { content: "..."; }
        }

        strong {
            color: var(--primary-color-dark);
        }
    </style>
</head>
<body>
    <header style="position: sticky;top:0;z-index: 1000;">
        <nav class="section_container nav_container">
            <div class="nav__logo"><span>云苓智体</span>中医体质AI解析与科学减肥服务平台</div>
            <ul class="nav__links">
                <li class="link"><a href="index.html" target="_blank">主页</a></li>
                <li class="link"><a href="#">平台简介</a></li>
                <li class="link"><a href="chat.html" target="_blank">AI解析</a></li>
                <li class="link"><a href="monitor.html" target="_blank">减肥服务</a></li> 
                <li class="link"><a href="monitor.html" target="_blank">数据监测</a></li>
                <li class="link"><a href="./products.html" target="_blank">健康产品</a></li>
                <li class="link"><a href="#">关于我们</a></li>
            </ul>
            <button class="btn">联系我们</button>
        </nav>
    </header>

    <section class="section__container chat_content_container">
        <h2 class="section__header" style="text-align: center; margin-bottom: 2rem;">AI 体质解析对话</h2>
        <div class="chat__container">
            <div class="chat__messages" id="chatMessages">
                <!-- 消息会动态添加到这里 -->
            </div>
            <div class="chat__input-area">
                <input type="text" id="chatInput" placeholder="请在此输入您的情况...">
                <button class="btn" id="sendBtn">发送</button>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="section__container footer__container">
            <div class="footer__col">
                <h3>云苓<span>智体</span></h3>
                <p>我们致力于结合传统中医智慧与现代AI技术，为您提供个性化的体质分析和科学减肥方案。</p>
                <p>信赖我们，让我们一同开启您的健康之旅。</p>
            </div>
            <div class="footer__col">
                <h4>关于我们</h4>
                <p><a href="./index.html" target="_blank">主页</a></p>
                <p>平台简介</p>
                <p><a href="./jianfei.html" target="_blank">减肥服务</a></p>
                <p><a href="./monitor.html" target="_blank">数据监测</a></p>
                <p><a href="./products.html" target="_blank">健康产品</a></p>
                <p>联系我们</p>
            </div>
            <div class="footer__col">
                <h4>服务支持</h4>
                <p>常见问题</p>
                <p>隐私政策</p>
                <p>服务条款</p>
                <p>技术支持</p>
            </div>
            <div class="footer__col">
                <h4>联系方式</h4>
                <p><i class="ri-map-pin-2-fill"></i>桂林电子科技大学花江校区</p>
                <p><i class="ri-mail-fill"></i> support@yunlingzhiti.com</p>
                <p><i class="ri-phone-fill"></i> (+86) 400-XXX-XXXX</p>
            </div>
        </div>
        <div class="footer__bar">
            <div class="footer__bar__content">
                <p>© 2025 云苓智体. All rights reserved.</p>
                <div class="footer__socials">
                    <span><i class="ri-instagram-line"></i></span>
                    <span><i class="ri-facebook-fill"></i></span>
                    <span><i class="ri-wechat-fill"></i></span>
                    <span><i class="ri-twitter-fill"></i></span>
                </div>
            </div>
        </div>
    </footer>

    <script>
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        // 添加计数器和付费状态
        let messageCount = 0;
        let isPaidUser = false;

        // AI回复模板
        const aiResponses = {
            greeting: [
                "您好！我是您的<span class='ai-name'>中医体质AI助手云苓</span>。请问您的身高体重是多少？",
                "很高兴见到您！我是<span class='ai-name'>云苓</span>，您的专业中医体质顾问。方便告诉我您的身高体重吗？"
            ],
            askHeight: [
                "请问您的<span class='keyword'>身高</span>是多少？",
                "能告诉我您的<span class='keyword'>身高</span>吗？"
            ],
            askWeight: [
                "请问您的<span class='keyword'>体重</span>是多少？",
                "能告诉我您的<span class='keyword'>体重</span>吗？"
            ],
            askSymptoms: [
                "除了体重问题，您是否还有以下<span class='keyword'>症状</span>：\n1. <span class='keyword'>容易疲劳</span>\n2. <span class='keyword'>手脚冷热</span>\n3. <span class='keyword'>睡眠质量</span>\n4. <span class='keyword'>饮食情况</span>",
                "了解了，除了体重情况，请问您是否有以下<span class='keyword'>症状</span>：\n1. <span class='keyword'>疲劳乏力</span>\n2. <span class='keyword'>手脚温度</span>\n3. <span class='keyword'>睡眠状况</span>\n4. <span class='keyword'>胃口情况</span>"
            ],
            constitutionTypes: {
                yangDeficiency: {
                    symptoms: "您的症状显示<span class='keyword'>阳虚体质</span>特征：\n- <span class='keyword'>手脚发凉</span>\n- <span class='keyword'>畏寒怕冷</span>\n- <span class='keyword'>精神疲乏</span>\n- <span class='keyword'>胃口欠佳</span>",
                    advice: "<span class='keyword'>阳虚体质</span>的初步建议：\n1. <span class='keyword'>注意保暖</span>\n2. <span class='keyword'>规律作息</span>\n3. <span class='keyword'>适量运动</span>，以温和运动为主\n4. <span class='keyword'>饮食宜温补</span>"
                },
                dampness: {
                    symptoms: "您的症状显示<span class='keyword'>痰湿体质</span>特征：\n- <span class='keyword'>容易疲劳</span>\n- <span class='keyword'>体型偏胖</span>\n- <span class='keyword'>面部油腻</span>\n- <span class='keyword'>胃口较好但易积食</span>",
                    advice: "<span class='keyword'>痰湿体质</span>的初步建议：\n1. <span class='keyword'>饮食清淡</span>\n2. <span class='keyword'>避免生冷</span>\n3. <span class='keyword'>加强有氧运动</span>\n4. <span class='keyword'>规律作息</span>"
                },
                phlegmStasis: {
                    symptoms: "您的症状显示痰瘀体质特征：\n- 体型肥胖\n- 易疲劳\n- 口粘腻\n- 容易积食",
                    advice: "痰瘀体质的初步建议：\n1. 控制饮食\n2. 加强运动\n3. 改善作息\n4. 情志调节"
                }
            },
            weightAnalysis: {
                slight: "根据您的身高{height}cm，体重{weight}kg，BMI指数为{bmi}，属于轻度超重。",
                moderate: "根据您的身高{height}cm，体重{weight}kg，BMI指数为{bmi}，属于中度肥胖。",
                severe: "根据您的身高{height}cm，体重{weight}kg，BMI指数为{bmi}，属于重度肥胖。"
            },
            paywall: [
                "看来您需要更专业的个性化建议。要获取完整的体质分析和定制方案，需要开通付费服务。\n\n我们将为您提供：\n✓ 专业的体质分析报告\n✓ 个性化调理方案\n✓ 一对一营养指导\n✓ 7×24小时咨询服务",
                "您的情况需要更深入的分析。建议开通付费服务，我们将为您提供：\n\n✓ 详细的体质评估\n✓ 个性化养生方案\n✓ 专业营养指导\n✓ 持续跟踪服务"
            ],
            fatigueAnalysis: {
                morning: "早晨疲惫可能与以下因素有关：\n1. 睡眠质量不佳\n2. 作息不规律\n3. 肝气郁滞\n\n初步建议：\n- 调整作息时间\n- 睡前泡脚\n- 避免熬夜",
                afternoon: "下午疲惫常见原因：\n1. 午饭过饱\n2. 阳气下陷\n3. 气血不足\n\n初步建议：\n- 午饭适量\n- 午休15-20分钟\n- 适当运动",
                night: "晚间疲惫分析：\n1. 工作压力\n2. 气血耗损\n3. 阴虚火旺\n\n初步建议：\n- 适度运动\n- 早睡早起\n- 情志调节"
            },
            sleepAnalysis: {
                insomnia: "失眠问题分析：\n1. 心神不宁\n2. 阴虚火旺\n3. 脾胃不和\n\n初步建议：\n- 睡前泡脚\n- 按摩太阳穴\n- 避免刺激性食物",
                lightSleep: "浅睡分析：\n1. 心脾两虚\n2. 肝气郁结\n3. 外界干扰\n\n初步建议：\n- 调节作息\n- 放松心情\n- 改善睡眠环境"
            },
            dietAnalysis: {
                poorAppetite: "食欲不振分析：\n1. 脾胃虚弱\n2. 情志影响\n3. 消化功能减退\n\n初步建议：\n- 少食多餐\n- 清淡易消化\n- 规律进餐",
                overeating: "易饥饿分析：\n1. 胃火旺盛\n2. 脾胃功能亢进\n3. 情绪性进食\n\n初步建议：\n- 控制进食速度\n- 选择粗粮\n- 补充优质蛋白"
            }
        };

        // 添加上下文追踪
        let conversationContext = {
            lastTopic: null,
            details: {
                weight: null,
                height: null,
                constitution: null,
                symptoms: [],
                dietHabits: [],
                analysisProvided: false
            }
        };

        // 计算BMI
        function calculateBMI(weight, height) {
            const heightInMeters = height / 100;
            return (weight / (heightInMeters * heightInMeters)).toFixed(1);
        }

        // 获取体重状态
        function getWeightStatus(bmi) {
            if (bmi < 24) return null;
            if (bmi < 28) return 'slight';
            if (bmi < 32) return 'moderate';
            return 'severe';
        }

        // 随机获取回复
        function getRandomResponse(category) {
            const responses = aiResponses[category];
            return responses[Math.floor(Math.random() * responses.length)];
        }

        // 判断是否需要付费回复
        function needsPremiumResponse(text) {
            // 直接触发付费提醒的关键短语
            const immediatePaywallPhrases = [
                '具体的调理方案',
                '具体调理方案',
                '详细的调理方案',
                '详细调理方案'
            ];

            // 如果包含直接触发付费的短语，立即返回true
            if (immediatePaywallPhrases.some(phrase => text.includes(phrase))) {
                return true;
            }

            // 其他需要付费的关键词
            const premiumKeywords = [
                '方案', '建议', '治疗', '怎么办', '开方', '药', '调理',
                '详细', '具体', '怎么做', '如何', '需要什么', '推荐'
            ];
            
            // 只有在已经提供了初步分析后，才会触发付费
            return conversationContext.details.analysisProvided && 
                   premiumKeywords.some(keyword => text.includes(keyword));
        }

        // 添加消息到聊天界面
        function addMessageToChat(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('chat__message', `chat__message--${sender}`);
            
            // 处理换行符
            const formattedText = text.replace(/\n/g, '<br>');
            messageElement.innerHTML = formattedText;
            
            chatMessages.appendChild(messageElement);
            scrollToBottom();
        }

        // 显示AI正在输入的提示
        function showTypingIndicator() {
            const typingIndicator = document.createElement('div');
            typingIndicator.id = 'typingIndicator';
            typingIndicator.classList.add('chat__message', 'chat__message--ai', 'typing-indicator');
            typingIndicator.innerHTML = '云苓正在思考';
            chatMessages.appendChild(typingIndicator);
            scrollToBottom();
        }

        // 移除输入提示
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // 添加付费按钮
        function addPaymentButton() {
            const paymentDiv = document.createElement('div');
            paymentDiv.className = 'payment-prompt';
            paymentDiv.innerHTML = `
                <button class="payment-button" onclick="handlePayment()">
                    开通付费服务 (￥99.9/月)
                </button>
                <p class="payment-note">开通后可获得：</p>
                <ul class="payment-benefits">
                    <li>专业的体质分析报告</li>
                    <li>个性化调理方案</li>
                    <li>一对一营养指导</li>
                    <li>7×24小时咨询服务</li>
                </ul>
            `;
            chatMessages.appendChild(paymentDiv);
            scrollToBottom();
        }

        // 处理付费点击
        function handlePayment() {
            alert('即将跳转到支付页面...');
            // isPaidUser = true; // 支付成功后设置为true
        }

        // 处理AI响应
        function handleAIResponse(userMessage) {
            messageCount++;
            let response;

            // 首先检查是否需要付费回复
            if (needsPremiumResponse(userMessage)) {
                response = getRandomResponse('paywall');
                addMessageToChat(response, 'ai');
                addPaymentButton();
                return;
            }

            // 提取身高体重数字
            const numbers = userMessage.match(/\d+/g);
            
            // 处理身高体重输入
            if (numbers && !conversationContext.details.height) {
                if (numbers[0] > 140 && numbers[0] < 200) {
                    conversationContext.details.height = numbers[0];
                    response = getRandomResponse('askWeight');
                    addMessageToChat(response, 'ai');
                    return;
                }
            }
            
            if (numbers && !conversationContext.details.weight && conversationContext.details.height) {
                if (numbers[0] > 30 && numbers[0] < 200) {
                    conversationContext.details.weight = numbers[0];
                    const bmi = calculateBMI(conversationContext.details.weight, conversationContext.details.height);
                    const status = getWeightStatus(bmi);
                    
                    if (status) {
                        response = aiResponses.weightAnalysis[status]
                            .replace('{height}', conversationContext.details.height)
                            .replace('{weight}', conversationContext.details.weight)
                            .replace('{bmi}', bmi);
                        addMessageToChat(response, 'ai');
                        
                        // 继续询问症状
                        setTimeout(() => {
                            response = getRandomResponse('askSymptoms');
                            addMessageToChat(response, 'ai');
                        }, 1000);
                        return;
                    }
                }
            }

            // 处理症状描述
            if (conversationContext.details.weight && conversationContext.details.height) {
                const symptoms = userMessage;
                conversationContext.details.symptoms.push(symptoms);
                
                // 根据症状判断体质类型
                if (symptoms.includes('冷') || symptoms.includes('寒')) {
                    response = aiResponses.constitutionTypes.yangDeficiency.symptoms + '\n\n' + 
                              aiResponses.constitutionTypes.yangDeficiency.advice;
                    conversationContext.details.constitution = 'yangDeficiency';
                } else if (symptoms.includes('疲') || symptoms.includes('累')) {
                    response = aiResponses.constitutionTypes.dampness.symptoms + '\n\n' + 
                              aiResponses.constitutionTypes.dampness.advice;
                    conversationContext.details.constitution = 'dampness';
                } else if (symptoms.includes('胖') || symptoms.includes('重')) {
                    response = aiResponses.constitutionTypes.phlegmStasis.symptoms + '\n\n' + 
                              aiResponses.constitutionTypes.phlegmStasis.advice;
                    conversationContext.details.constitution = 'phlegmStasis';
                }
                
                if (response) {
                    conversationContext.details.analysisProvided = true;
                    addMessageToChat(response, 'ai');
                    return;
                }
            }

            // 初始对话
            if (userMessage.includes("你好") || userMessage.includes("您好")) {
                response = getRandomResponse('greeting');
            } else {
                response = "请告诉我您的具体情况，比如身高、体重、以及是否有以下症状：\n- 疲劳乏力\n- 手脚冷热\n- 睡眠质量\n- 饮食情况";
            }

            addMessageToChat(response, 'ai');
        }

        // 发送消息的函数
        function sendMessage() {
            const messageText = chatInput.value.trim();

            if (messageText !== "") {
                // 添加用户消息到界面
                addMessageToChat(messageText, 'user');
                
                // 清空输入框并重新获得焦点
                chatInput.value = "";
                chatInput.focus();

                // 显示AI正在输入的提示
                showTypingIndicator();

                // 延迟模拟AI思考和回复
                setTimeout(() => {
                    removeTypingIndicator();
                    handleAIResponse(messageText);
                }, 1000);
            }
        }

        // 滚动到聊天记录底部的函数
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // 事件监听器
        sendBtn.addEventListener('click', sendMessage);
        chatInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                sendMessage();
            }
        });

        // 页面加载完成后自动显示欢迎消息
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                addMessageToChat(getRandomResponse('greeting'), 'ai');
            }, 500);
        });
    </script>
</body>
</html>
